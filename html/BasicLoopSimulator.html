
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>BasicLoopSimulator</title><meta name="generator" content="MATLAB 9.2"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2017-08-05"><meta name="DC.source" content="BasicLoopSimulator.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><pre class="codeinput"><span class="comment">% A Very Basic Loop Simulator</span>
<span class="comment">% dm61 8/5/2017</span>

<span class="comment">% Assumptions and limitations</span>
<span class="comment">%   IOB(0)=0, COB(0)=0</span>
<span class="comment">%   Single meal with known carb absorption</span>
<span class="comment">%   Ideal system model: deltaBG = (carb impact)-(insulin impact)</span>
<span class="comment">%   Does not incude Loop RC or momentum effects or dynamic carb algorithm</span>
<span class="comment">%   Includes exponential insulin absorption curves with td, tp parameters</span>
<span class="comment">%   Includes current Loop and dynamic dosing algorithms (see: algorithm below)</span>

<span class="comment">% global variables accessed from ci_generate</span>
<span class="keyword">global</span> DIA; <span class="comment">% duration of insulin action [h], td = DIA</span>
<span class="keyword">global</span> ISF; <span class="comment">% insulin sensitivity factor [(mg/dL)/U]</span>
<span class="keyword">global</span> CIR; <span class="comment">% carb to insulin ratio [g/U]</span>
<span class="keyword">global</span> n_sim; <span class="comment">% number of 5-min simulation steps</span>

<span class="comment">% setup meal, system, algorithm, and simulation parameters</span>
meal_carbs = 50; <span class="comment">% grams of carbs in the meal</span>
meal_absorption_time = 5*60; <span class="comment">% carbs absorption time in minutes</span>
<span class="comment">% default constant absorption rate, arbitrary curve can be setup below</span>
meal_start_time = 60; <span class="comment">% meal time in minutes after start of simulation</span>
pre_bolus_time = 20; <span class="comment">% pre-bolus time (i.e. time when meal entered), in minutes ahead of the meal</span>
bg_initial = 100; <span class="comment">% initial bg value [mg/dL]</span>

<span class="comment">% algorithm options</span>
algorithm.bolus = false; <span class="comment">% true = use dynamic dosing for bolus, false = current Loop</span>
algorithm.temp = false; <span class="comment">% true = use dynamic dosing for temps, false = current Loop</span>
algorithm.accept = true; <span class="comment">% true = accept and deliver bolus, false = let Loop handle all</span>
algorithm.alpha = 0.5; <span class="comment">% agressiveness factor, 0 = no dynamic super bolusing</span>
sim_time = 12; <span class="comment">% simulation time [h]</span>
pause_times = []; <span class="comment">% array of time indeces (1 to n_sim), e.g. [1 10 20] to pause and show current display prediction curve</span>

<span class="comment">% system parameters</span>
DIA = 6;
ISF = 50;
CIR = 10;
bg_target_max = 100; <span class="comment">% uppper limit of the bg target</span>
bg_target_min = 100; <span class="comment">% lower limit of the bg target</span>
bg_guard = 70; <span class="comment">% bg guard, no bolus suggested below this level, zero temp below this level</span>
bg_target = (bg_target_max+bg_target_min)/2; <span class="comment">% target bg value</span>
basal_rate = 0.5; <span class="comment">% nominal basal rate [U/h]</span>
max_temp_rate = 5.0; <span class="comment">% maximum temp [U/h]</span>
min_temp_rate = -basal_rate; <span class="comment">% minimum temp (negative) [U/h]</span>

<span class="comment">% simulation setup</span>
n_sim = round(sim_time*60/5)+1; <span class="comment">% total number of simulation points</span>
sim_time_minutes = n_sim*5;
times = 0:5:(n_sim-1)*5;
n_bolus = round((meal_start_time - pre_bolus_time)/5)+1; <span class="comment">% time index when meal entered and bolus suggested</span>
nDIA = round(DIA*60/5)+1; <span class="comment">% number of time slots in DIA</span>

<span class="comment">% setup insulin absorption curves</span>
<span class="comment">% normalized scalable exponential insulin activity and IOB curves</span>
td = DIA*60; <span class="comment">% insulin duration in minutes</span>
tp = 75; <span class="comment">% insulin peak time, nominally Novolog = 75, fiasp = 55</span>
<span class="comment">% insulin curves</span>
tau = tp*(td-tp)/(td-2*tp); <span class="comment">% time constant of exp decay</span>
S = ((td/tau)^2)*exp(td/tau)/((td-2*tau)*exp(td/tau)+td+2*tau); <span class="comment">% aux scale factor</span>
Ia = @(t) S.*(t./td).*(1-t./td).*exp(-t/tau); <span class="comment">% insulin activity (AUC=1)</span>
IOB = @(t) 1-(S/td).*(tau/td).*(exp(-t/tau).*(t.^2 - td*(t+tau) +2*tau^2 + 2*tau*t)+tau*(td-2*tau));

<span class="comment">% dynamic dosing algorithm parameters and functions</span>
low_temp_scale = -(min_temp_rate/60)*ISF; <span class="comment">% asymptote of the bg rate of change due to zero temping</span>
<span class="comment">% bg impact of zero temping as a function of time</span>
BGTempImpact = @(t) low_temp_scale*(S/td)*(tau/td)*tau*<span class="keyword">...</span>
    (exp(-t/tau).*(-6*tau^2+2*tau*(td-2*t)+t.*(td-t))+<span class="keyword">...</span>
    6*tau^2-2*tau*td-2*tau*t+td*t);
<span class="comment">% dynamic target sliding from bg_gard at t=0 to bg_target at td</span>
BGtarget = @(t) bg_guard + (bg_target-bg_guard)*t/td; <span class="comment">% dynamic target</span>

<span class="comment">% initiate bg array</span>
bg = zeros(n_sim,1); <span class="comment">% initiate bg array</span>
bg(1) = bg_initial; <span class="comment">% initial bg value</span>
bg_predicted = bg; <span class="comment">% predicted bg array</span>

<span class="comment">% meal setup, flat rate assumed below, can be modified easily</span>
ci_meal.carbs = meal_carbs; <span class="comment">% total meal carbs [g]</span>
ci_meal.time = [0 1 meal_absorption_time-1 meal_absorption_time]'; <span class="comment">% meal ci time points [minutes]</span>
ci_meal.value = [0 1 1 0]'; <span class="comment">% meal ci relative values, scaled in ci_generate func</span>
meal_start = meal_start_time; <span class="comment">% meal start time [min], default to 60min</span>
ci_meal.start = meal_start/5+1; <span class="comment">% start time index</span>
ci = ci_generate(ci_meal); <span class="comment">% generate actual carb impact array [(mg/dL)/5min]</span>
<span class="comment">% what Loop thinks the meal is (assumed ideally the same as of now)</span>
ci_meal_loop = ci_meal; <span class="comment">% ideally the same as the actual carbs</span>
meal_start_loop = meal_start; <span class="comment">% meal start time (Loop) [min]</span>
ci_meal_loop.start = meal_start_loop/5+1; <span class="comment">% (Loop) start time index</span>
ci_loop = ci_generate(ci_meal_loop); <span class="comment">% generate Loop model carb impact array</span>

<span class="comment">% setup insulin impact array and temp basal array</span>
bg_impact = zeros(n_sim,1);
temp_basal = zeros(n_sim,1);
DIA_times = 5:5:(nDIA-1)*5; <span class="comment">% array of DIA times, excluding zero</span>
I_activity_array = 5*Ia(0:5:(nDIA-1)*5)'; <span class="comment">% array of insulin activity over DIA</span>

<span class="comment">% run simulation</span>
<span class="keyword">for</span> i=2:n_sim

    <span class="comment">% bolus calculation</span>
    <span class="keyword">if</span>(i == n_bolus) <span class="comment">% enter meal and deliver bolus</span>
        <span class="keyword">for</span> j=2:n_sim <span class="comment">% enter carb impact to bg_predicted array</span>
            bg_predicted(j) = bg_predicted(j-1) + ci.value(j);
        <span class="keyword">end</span>
        <span class="keyword">if</span>(~algorithm.bolus)
            <span class="comment">% conventional dosing</span>
            bolus = (bg_predicted(i+nDIA-1)-bg_target)/ISF;
            bolus = max(0,bolus);
        <span class="keyword">else</span>
            <span class="comment">% dynamic dosing</span>
            suggested_bolus_array = <span class="keyword">...</span>
                (bg_predicted(i+1:i+nDIA-1)+algorithm.alpha*BGTempImpact(DIA_times)'-BGtarget(DIA_times)')./ <span class="keyword">...</span>
                (1-IOB(DIA_times)')/ISF;
            bolus = min(suggested_bolus_array);
            bolus = max(0,bolus);
        <span class="keyword">end</span>
        <span class="keyword">if</span>(~algorithm.accept) <span class="comment">% algorithm option to not deliver suggested bolus</span>
            bolus = 0;
        <span class="keyword">end</span>
        bg_impact(i:i+nDIA-1) = bg_impact(i:i+nDIA-1)+bolus*ISF*I_activity_array;
    <span class="keyword">end</span>

    <span class="comment">% system model: update bg</span>
    bg(i) = bg(i-1) + ci.value(i)- bg_impact(i); <span class="comment">% actual bg update</span>

    <span class="comment">% initialize predicted bg array</span>
    <span class="keyword">if</span>( i&gt;= n_bolus)
        bg_predicted = bg; <span class="comment">% reset predicted bg values to current bg array</span>
    <span class="keyword">else</span>
        bg_predicted = bg_initial*ones(n_sim,1);
    <span class="keyword">end</span>

    <span class="comment">% temp dosing calculation</span>
    <span class="keyword">if</span>(i+nDIA &lt;= n_sim)

        <span class="keyword">if</span>(i &gt;= n_bolus) <span class="comment">% update prediction only after the meal is entered</span>
            <span class="keyword">for</span> j=i+1:n_sim <span class="comment">% update prediction based on insulin delivered so far</span>
                bg_predicted(j) = bg_predicted(j-1) + ci.value(j)-bg_impact(j); <span class="comment">% model based simulation</span>
            <span class="keyword">end</span>
        <span class="keyword">end</span>

        <span class="keyword">if</span> any(pause_times == i) <span class="comment">% pause to show current prediction</span>
            clf;
            plot(ci.time,bg_predicted,<span class="string">'k'</span>,<span class="string">'LineWidth'</span>,2);
            disp(bg_predicted(i+nDIA));
            grid <span class="string">on</span>;
            pause;
        <span class="keyword">end</span>

        <span class="keyword">if</span>(i &gt;= n_bolus) <span class="comment">% temps only if meal has been entered since we assume IOB=0,COB=0 initially</span>
            <span class="keyword">if</span>(~algorithm.temp)
                <span class="comment">% current Loop temp dosing</span>
                five_minute_dose = ((bg_predicted(i+nDIA)-bg_target)/ISF)*5/30;
            <span class="keyword">else</span>
                <span class="comment">% dynamic temp dosing</span>
                suggested_dose_array = <span class="keyword">...</span>
                    (bg_predicted(i+1:i+nDIA-1)-BGtarget(DIA_times)')./ <span class="keyword">...</span>
                    (1-IOB(DIA_times)')/ISF;
                suggested_dose = min(suggested_dose_array);
                five_minute_dose = suggested_dose*5/30; <span class="comment">% spread over 30 minutes as Loop currently does</span>
                <span class="comment">%five_minute_dose = suggested dose; % all in 5 min</span>
            <span class="keyword">end</span>
        <span class="keyword">else</span>
            five_minute_dose = 0;
        <span class="keyword">end</span>

        <span class="comment">% Loop conditions</span>
        <span class="keyword">if</span>(five_minute_dose*60/5 &gt; max_temp_rate) <span class="comment">% max temp rate</span>
            five_minute_dose = max_temp_rate*5/60;
        <span class="keyword">end</span>

        <span class="keyword">if</span>(five_minute_dose*60/5 &lt; min_temp_rate) <span class="comment">% min temp rate</span>
            five_minute_dose = min_temp_rate*5/60;
        <span class="keyword">end</span>

        <span class="keyword">if</span> any(bg_predicted(i+1:n_sim) &lt; bg_guard) <span class="comment">% bg guard</span>
            five_minute_dose = min_temp_rate*5/60;
        <span class="keyword">end</span>

        <span class="comment">% add temp effect to insulin impact array</span>
        bg_impact(i+1:i+nDIA) = bg_impact(i+1:i+nDIA)+ <span class="keyword">...</span>
            five_minute_dose*ISF*I_activity_array;

        <span class="comment">% update temp basal array (for plotting)</span>
        temp_basal(i+1) = five_minute_dose*60/5; <span class="comment">% temp basal [U/h]</span>

    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">% outputs</span>
[BGmin, indexBGmin] = min(bg);
[BGmax, indexBGmax] = max(bg);
fprintf(<span class="string">'\ndosing algorithm options\n'</span>);
disp(algorithm);
fprintf(<span class="string">'bolus = %4.2f\n'</span>,bolus); <span class="comment">% maximum bg over simulation time</span>
fprintf(<span class="string">'maximum BG = %3.0f\n'</span>,BGmax); <span class="comment">% maximum bg over simulation time</span>
fprintf(<span class="string">'minimum BG = %3.0f\n'</span>,BGmin); <span class="comment">% minimum bg over simulation time</span>
plot_times = ci.time-meal_start_time;
[xt,yt] = stairs(ci.time,temp_basal); <span class="comment">% nicer plot of temps</span>

<span class="comment">% plot labels</span>
strmin = num2str(round(BGmin));
strmax = num2str(round(BGmax));
<span class="keyword">if</span>(algorithm.bolus)
    titlestr = [<span class="string">'dynamic dosing, \alpha = '</span> num2str(algorithm.alpha)];
<span class="keyword">else</span>
    titlestr = <span class="string">'DIA dosing'</span>;
<span class="keyword">end</span>
<span class="keyword">if</span>(algorithm.accept)
    bolusstr = [<span class="string">', bolus = '</span> num2str(round(bolus,2))];
<span class="keyword">else</span>
    bolusstr = <span class="string">', skip bolus'</span>;
<span class="keyword">end</span>
<span class="keyword">if</span>(algorithm.temp)
    tempstr = [<span class="string">'dynamic dosing, min = '</span> num2str(min_temp_rate) <span class="string">', max = '</span> num2str(max_temp_rate) ];
<span class="keyword">else</span>
    tempstr = [<span class="string">'DIA dosing, min = '</span> num2str(min_temp_rate) <span class="string">', max = '</span> num2str(max_temp_rate) ];
<span class="keyword">end</span>

<span class="comment">% plot results</span>
<span class="comment">% choose where to plot depending on algorithm choice</span>
<span class="keyword">if</span>(algorithm.bolus)
    <span class="keyword">if</span>(algorithm.temp)
        figure(1);
    <span class="keyword">else</span>
        figure(2);
    <span class="keyword">end</span>
<span class="keyword">else</span>
    figure(3);
<span class="keyword">end</span>
clf;

subplot(3,1,1) <span class="comment">% insulin activity and carb counteraction</span>
    hold <span class="string">on</span>;
    plot(plot_times,bg_impact,<span class="string">'g'</span>,<span class="string">'LineWidth'</span>,2);
    plot(plot_times,ci.value,<span class="string">'r'</span>,<span class="string">'LineWidth'</span>,2);
     axis([-meal_start_time <span class="keyword">...</span>
     sim_time_minutes-meal_start_time <span class="keyword">...</span>
     -1 inf]);
    title([<span class="string">'Insulin action and counteraction, '</span> titlestr bolusstr <span class="keyword">...</span>
        <span class="string">', DIA = '</span> num2str(DIA) <span class="string">', tp = '</span> num2str(tp)],<span class="keyword">...</span>
        <span class="string">'FontSize'</span>,10,<span class="string">'FontWeight'</span>,<span class="string">'normal'</span>);
    grid <span class="string">on</span>;
    hold <span class="string">off</span>;

subplot(3,1,2) <span class="comment">% bg</span>
    hold <span class="string">on</span>;
    plot(plot_times,bg,<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,2);
    plot(plot_times,bg_guard*ones(n_sim,1),<span class="string">'r'</span>,<span class="string">'LineWidth'</span>,1);
    plot(plot_times,bg_target*ones(n_sim,1),<span class="string">'--k'</span>,<span class="string">'LineWidth'</span>,1);
    grid <span class="string">on</span>;
     axis([-meal_start_time <span class="keyword">...</span>
     sim_time_minutes-meal_start_time <span class="keyword">...</span>
     50 200]);
    title(<span class="string">'BG [mg/dL]'</span>,<span class="string">'FontSize'</span>,10,<span class="string">'FontWeight'</span>,<span class="string">'normal'</span>);
    text(plot_times(indexBGmin),BGmin,strmin);
    text(plot_times(indexBGmax),BGmax,strmax);
    hold <span class="string">off</span>;

subplot(3,1,3) <span class="comment">% temps</span>
    hold <span class="string">on</span>;
    plot(xt-meal_start_time,yt,<span class="string">'k'</span>,<span class="string">'LineWidth'</span>,2);
    grid <span class="string">on</span>;
     axis([-meal_start_time <span class="keyword">...</span>
     sim_time_minutes-meal_start_time <span class="keyword">...</span>
     min_temp_rate max_temp_rate]);
    title([<span class="string">'Basal [U/h], '</span> tempstr], <span class="keyword">...</span>
        <span class="string">'FontSize'</span>,10,<span class="string">'FontWeight'</span>,<span class="string">'normal'</span>);
    hold <span class="string">off</span>;
</pre><pre class="codeoutput">
dosing algorithm options
     bolus: 0
      temp: 0
    accept: 1
     alpha: 0.5000

bolus = 5.00
maximum BG = 135
minimum BG =  55
</pre><img vspace="5" hspace="5" src="BasicLoopSimulator_01.png" alt=""> <p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2017a</a><br></p></div><!--
##### SOURCE BEGIN #####
% A Very Basic Loop Simulator
% dm61 8/5/2017

% Assumptions and limitations 
%   IOB(0)=0, COB(0)=0
%   Single meal with known carb absorption  
%   Ideal system model: deltaBG = (carb impact)-(insulin impact)
%   Does not incude Loop RC or momentum effects or dynamic carb algorithm
%   Includes exponential insulin absorption curves with td, tp parameters
%   Includes current Loop and dynamic dosing algorithms (see: algorithm below) 

% global variables accessed from ci_generate
global DIA; % duration of insulin action [h], td = DIA
global ISF; % insulin sensitivity factor [(mg/dL)/U]
global CIR; % carb to insulin ratio [g/U]
global n_sim; % number of 5-min simulation steps

% setup meal, system, algorithm, and simulation parameters
meal_carbs = 50; % grams of carbs in the meal
meal_absorption_time = 5*60; % carbs absorption time in minutes
% default constant absorption rate, arbitrary curve can be setup below
meal_start_time = 60; % meal time in minutes after start of simulation
pre_bolus_time = 20; % pre-bolus time (i.e. time when meal entered), in minutes ahead of the meal
bg_initial = 100; % initial bg value [mg/dL]

% algorithm options
algorithm.bolus = false; % true = use dynamic dosing for bolus, false = current Loop
algorithm.temp = false; % true = use dynamic dosing for temps, false = current Loop
algorithm.accept = true; % true = accept and deliver bolus, false = let Loop handle all
algorithm.alpha = 0.5; % agressiveness factor, 0 = no dynamic super bolusing
sim_time = 12; % simulation time [h]
pause_times = []; % array of time indeces (1 to n_sim), e.g. [1 10 20] to pause and show current display prediction curve

% system parameters
DIA = 6;
ISF = 50;
CIR = 10;
bg_target_max = 100; % uppper limit of the bg target
bg_target_min = 100; % lower limit of the bg target
bg_guard = 70; % bg guard, no bolus suggested below this level, zero temp below this level
bg_target = (bg_target_max+bg_target_min)/2; % target bg value
basal_rate = 0.5; % nominal basal rate [U/h]
max_temp_rate = 5.0; % maximum temp [U/h]
min_temp_rate = -basal_rate; % minimum temp (negative) [U/h]

% simulation setup
n_sim = round(sim_time*60/5)+1; % total number of simulation points
sim_time_minutes = n_sim*5;
times = 0:5:(n_sim-1)*5;
n_bolus = round((meal_start_time - pre_bolus_time)/5)+1; % time index when meal entered and bolus suggested
nDIA = round(DIA*60/5)+1; % number of time slots in DIA

% setup insulin absorption curves
% normalized scalable exponential insulin activity and IOB curves
td = DIA*60; % insulin duration in minutes
tp = 75; % insulin peak time, nominally Novolog = 75, fiasp = 55
% insulin curves
tau = tp*(td-tp)/(td-2*tp); % time constant of exp decay
S = ((td/tau)^2)*exp(td/tau)/((td-2*tau)*exp(td/tau)+td+2*tau); % aux scale factor
Ia = @(t) S.*(t./td).*(1-t./td).*exp(-t/tau); % insulin activity (AUC=1)
IOB = @(t) 1-(S/td).*(tau/td).*(exp(-t/tau).*(t.^2 - td*(t+tau) +2*tau^2 + 2*tau*t)+tau*(td-2*tau));

% dynamic dosing algorithm parameters and functions
low_temp_scale = -(min_temp_rate/60)*ISF; % asymptote of the bg rate of change due to zero temping
% bg impact of zero temping as a function of time
BGTempImpact = @(t) low_temp_scale*(S/td)*(tau/td)*tau*...
    (exp(-t/tau).*(-6*tau^2+2*tau*(td-2*t)+t.*(td-t))+...
    6*tau^2-2*tau*td-2*tau*t+td*t);
% dynamic target sliding from bg_gard at t=0 to bg_target at td
BGtarget = @(t) bg_guard + (bg_target-bg_guard)*t/td; % dynamic target

% initiate bg array
bg = zeros(n_sim,1); % initiate bg array
bg(1) = bg_initial; % initial bg value
bg_predicted = bg; % predicted bg array

% meal setup, flat rate assumed below, can be modified easily
ci_meal.carbs = meal_carbs; % total meal carbs [g]
ci_meal.time = [0 1 meal_absorption_time-1 meal_absorption_time]'; % meal ci time points [minutes]
ci_meal.value = [0 1 1 0]'; % meal ci relative values, scaled in ci_generate func 
meal_start = meal_start_time; % meal start time [min], default to 60min
ci_meal.start = meal_start/5+1; % start time index
ci = ci_generate(ci_meal); % generate actual carb impact array [(mg/dL)/5min]
% what Loop thinks the meal is (assumed ideally the same as of now)
ci_meal_loop = ci_meal; % ideally the same as the actual carbs
meal_start_loop = meal_start; % meal start time (Loop) [min]
ci_meal_loop.start = meal_start_loop/5+1; % (Loop) start time index
ci_loop = ci_generate(ci_meal_loop); % generate Loop model carb impact array

% setup insulin impact array and temp basal array
bg_impact = zeros(n_sim,1);
temp_basal = zeros(n_sim,1);
DIA_times = 5:5:(nDIA-1)*5; % array of DIA times, excluding zero
I_activity_array = 5*Ia(0:5:(nDIA-1)*5)'; % array of insulin activity over DIA

% run simulation 
for i=2:n_sim
    
    % bolus calculation
    if(i == n_bolus) % enter meal and deliver bolus
        for j=2:n_sim % enter carb impact to bg_predicted array
            bg_predicted(j) = bg_predicted(j-1) + ci.value(j); 
        end
        if(~algorithm.bolus)
            % conventional dosing
            bolus = (bg_predicted(i+nDIA-1)-bg_target)/ISF;
            bolus = max(0,bolus);
        else
            % dynamic dosing
            suggested_bolus_array = ...
                (bg_predicted(i+1:i+nDIA-1)+algorithm.alpha*BGTempImpact(DIA_times)'-BGtarget(DIA_times)')./ ...
                (1-IOB(DIA_times)')/ISF;
            bolus = min(suggested_bolus_array);
            bolus = max(0,bolus);
        end
        if(~algorithm.accept) % algorithm option to not deliver suggested bolus
            bolus = 0; 
        end 
        bg_impact(i:i+nDIA-1) = bg_impact(i:i+nDIA-1)+bolus*ISF*I_activity_array;
    end
    
    % system model: update bg 
    bg(i) = bg(i-1) + ci.value(i)- bg_impact(i); % actual bg update

    % initialize predicted bg array
    if( i>= n_bolus)
        bg_predicted = bg; % reset predicted bg values to current bg array
    else
        bg_predicted = bg_initial*ones(n_sim,1);
    end
    
    % temp dosing calculation 
    if(i+nDIA <= n_sim)

        if(i >= n_bolus) % update prediction only after the meal is entered
            for j=i+1:n_sim % update prediction based on insulin delivered so far
                bg_predicted(j) = bg_predicted(j-1) + ci.value(j)-bg_impact(j); % model based simulation
            end
        end
        
        if any(pause_times == i) % pause to show current prediction
            clf;
            plot(ci.time,bg_predicted,'k','LineWidth',2);
            disp(bg_predicted(i+nDIA));
            grid on;
            pause;
        end
        
        if(i >= n_bolus) % temps only if meal has been entered since we assume IOB=0,COB=0 initially
            if(~algorithm.temp)
                % current Loop temp dosing
                five_minute_dose = ((bg_predicted(i+nDIA)-bg_target)/ISF)*5/30;
            else
                % dynamic temp dosing
                suggested_dose_array = ...
                    (bg_predicted(i+1:i+nDIA-1)-BGtarget(DIA_times)')./ ...
                    (1-IOB(DIA_times)')/ISF;
                suggested_dose = min(suggested_dose_array);
                five_minute_dose = suggested_dose*5/30; % spread over 30 minutes as Loop currently does
                %five_minute_dose = suggested dose; % all in 5 min
            end
        else
            five_minute_dose = 0;
        end
        
        % Loop conditions
        if(five_minute_dose*60/5 > max_temp_rate) % max temp rate
            five_minute_dose = max_temp_rate*5/60;
        end
        
        if(five_minute_dose*60/5 < min_temp_rate) % min temp rate
            five_minute_dose = min_temp_rate*5/60;
        end
        
        if any(bg_predicted(i+1:n_sim) < bg_guard) % bg guard
            five_minute_dose = min_temp_rate*5/60;
        end
        
        % add temp effect to insulin impact array
        bg_impact(i+1:i+nDIA) = bg_impact(i+1:i+nDIA)+ ...
            five_minute_dose*ISF*I_activity_array; 
        
        % update temp basal array (for plotting)
        temp_basal(i+1) = five_minute_dose*60/5; % temp basal [U/h]
    
    end
end

% outputs
[BGmin, indexBGmin] = min(bg);
[BGmax, indexBGmax] = max(bg);
fprintf('\ndosing algorithm options\n');
disp(algorithm);
fprintf('bolus = %4.2f\n',bolus); % maximum bg over simulation time
fprintf('maximum BG = %3.0f\n',BGmax); % maximum bg over simulation time
fprintf('minimum BG = %3.0f\n',BGmin); % minimum bg over simulation time 
plot_times = ci.time-meal_start_time;
[xt,yt] = stairs(ci.time,temp_basal); % nicer plot of temps

% plot labels
strmin = num2str(round(BGmin));
strmax = num2str(round(BGmax));
if(algorithm.bolus)
    titlestr = ['dynamic dosing, \alpha = ' num2str(algorithm.alpha)];
else
    titlestr = 'DIA dosing';
end
if(algorithm.accept)
    bolusstr = [', bolus = ' num2str(round(bolus,2))];
else
    bolusstr = ', skip bolus';
end
if(algorithm.temp)
    tempstr = ['dynamic dosing, min = ' num2str(min_temp_rate) ', max = ' num2str(max_temp_rate) ];
else
    tempstr = ['DIA dosing, min = ' num2str(min_temp_rate) ', max = ' num2str(max_temp_rate) ];
end

% plot results
% choose where to plot depending on algorithm choice
if(algorithm.bolus)
    if(algorithm.temp)
        figure(1);
    else
        figure(2);
    end
else
    figure(3);
end
clf;

subplot(3,1,1) % insulin activity and carb counteraction  
    hold on;
    plot(plot_times,bg_impact,'g','LineWidth',2);
    plot(plot_times,ci.value,'r','LineWidth',2);
     axis([-meal_start_time ...
     sim_time_minutes-meal_start_time ...
     -1 inf]);
    title(['Insulin action and counteraction, ' titlestr bolusstr ...
        ', DIA = ' num2str(DIA) ', tp = ' num2str(tp)],...
        'FontSize',10,'FontWeight','normal');
    grid on;
    hold off;

subplot(3,1,2) % bg
    hold on;
    plot(plot_times,bg,'b','LineWidth',2);
    plot(plot_times,bg_guard*ones(n_sim,1),'r','LineWidth',1);
    plot(plot_times,bg_target*ones(n_sim,1),'REPLACE_WITH_DASH_DASHk','LineWidth',1);
    grid on;
     axis([-meal_start_time ...
     sim_time_minutes-meal_start_time ...
     50 200]);
    title('BG [mg/dL]','FontSize',10,'FontWeight','normal');
    text(plot_times(indexBGmin),BGmin,strmin);
    text(plot_times(indexBGmax),BGmax,strmax);
    hold off;

subplot(3,1,3) % temps
    hold on;
    plot(xt-meal_start_time,yt,'k','LineWidth',2);
    grid on;
     axis([-meal_start_time ...
     sim_time_minutes-meal_start_time ...
     min_temp_rate max_temp_rate]);
    title(['Basal [U/h], ' tempstr], ...
        'FontSize',10,'FontWeight','normal');
    hold off;
    
##### SOURCE END #####
--></body></html>